---
/**
 * FIDUBIT - Header Component
 * Premium glass header with state management and navigation
 */
import { navigation, siteConfig } from '@/data/site';

interface Props {
  class?: string;
  currentPath?: string;
}

const { class: className } = Astro.props;

// Get current path for active state
const currentPath = Astro.url.pathname;

const getColorClasses = (color: string) => {
  const colors: Record<string, { text: string; bg: string; border: string }> = {
    yellow: { text: 'text-yellow-500', bg: 'bg-yellow-500', border: 'border-yellow-500/30' },
    blue: { text: 'text-blue-500', bg: 'bg-blue-500', border: 'border-blue-500/30' },
    purple: { text: 'text-purple-500', bg: 'bg-purple-500', border: 'border-purple-500/30' },
    fuchsia: { text: 'text-fuchsia-500', bg: 'bg-fuchsia-500', border: 'border-fuchsia-500/30' },
    green: { text: 'text-green-500', bg: 'bg-green-500', border: 'border-green-500/30' },
  };
  return colors[color] || colors.yellow;
};

// Check if a nav item is active
const isActive = (href: string) => {
  // For page links like /staff
  if (!href.includes('#')) {
    return currentPath === href || currentPath === href + '/';
  }
  // For section links - active state handled by JS
  return false;
};

// Get the correct href for navigation
const getHref = (href: string) => {
  // If it's a page link (no hash), return as is
  if (!href.includes('#')) return href;
  
  // If we're on the home page, use just the hash
  if (currentPath === '/' || currentPath === '') {
    return href.replace('/', '');
  }
  
  // Otherwise, use full path with hash
  return href.startsWith('/') ? href : '/' + href;
};
---

<header 
  class:list={["fixed top-0 left-0 right-0 z-50 h-16 glass-header flex items-stretch", className]}
  id="main-header"
>
  <!-- Logo -->
  <a 
    href="/"
    class="flex items-center gap-3 px-6 border-r border-white/5 cursor-pointer group bg-black/30 hover:bg-black/50 transition-colors"
    aria-label="Go to home"
  >
    <div class="relative">
      <div class="w-8 h-8 bg-gradient-to-br from-yellow-500 to-yellow-600 rounded-lg flex items-center justify-center shadow-lg shadow-yellow-500/20 group-hover:shadow-yellow-500/40 transition-shadow">
        <span class="text-black font-bold text-sm">F</span>
      </div>
      <div class="absolute -bottom-0.5 -right-0.5 w-2 h-2 bg-green-500 rounded-full border-2 border-black animate-pulse"></div>
    </div>
    <div class="hidden sm:block">
      <span class="text-white font-bold tracking-tight group-hover:text-yellow-400 transition-colors">
        {siteConfig.name}
      </span>
      <span class="text-[9px] text-zinc-600 font-mono block -mt-0.5">SYSTEMS</span>
    </div>
  </a>
  
  <!-- Main Navigation -->
  <nav class="hidden lg:flex flex-1 items-stretch justify-center" aria-label="Main navigation" id="main-nav">
    {navigation.map((item) => {
      const colors = getColorClasses(item.accentColor || 'yellow');
      const active = isActive(item.href);
      const href = getHref(item.href);
      const isExternal = !item.href.includes('#');
      const sectionId = item.href.includes('#') ? item.href.split('#')[1] : null;
      
      return (
        <a 
          href={href}
          class:list={[
            "nav-link group relative flex items-center gap-2 px-5 text-[11px] font-mono uppercase tracking-wider transition-all duration-300 border-l border-white/5",
            active ? "text-white" : "text-zinc-400 hover:text-white"
          ]}
          data-section={sectionId}
          data-external={isExternal ? "true" : undefined}
        >
          <!-- Active/Hover Background -->
          <span 
            class:list={[
              "absolute inset-0 bg-gradient-to-b from-white/[0.03] to-transparent transition-opacity",
              active ? "opacity-100" : "opacity-0 group-hover:opacity-100"
            ]}
          ></span>
          
          <!-- Icon -->
          {item.icon && (
            <iconify-icon 
              icon={item.icon} 
              width="14" 
              class:list={[
                "transition-opacity",
                colors.text,
                active ? "opacity-100" : "opacity-40 group-hover:opacity-100"
              ]}
            ></iconify-icon>
          )}
          
          <!-- Label -->
          <span class="relative z-10">{item.label}</span>
          
          <!-- Active Indicator Line -->
          <div 
            class:list={[
              "nav-indicator absolute bottom-0 left-0 w-full h-[2px] transition-transform duration-300 origin-left",
              colors.bg,
              active ? "scale-x-100" : "scale-x-0 group-hover:scale-x-100"
            ]}
          ></div>
        </a>
      );
    })}
  </nav>

  <!-- Right Section -->
  <div class="flex items-stretch ml-auto">
    <!-- Status -->
    <div class="hidden md:flex items-center px-4 border-l border-white/5 gap-2">
      <span class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></span>
      <span class="text-[9px] font-mono text-zinc-500 uppercase">Online</span>
    </div>
    
    <!-- CTA -->
    <a 
      href={currentPath === '/' ? '#contact-section' : '/#contact-section'}
      class="group relative px-6 border-l border-white/5 bg-gradient-to-r from-yellow-500 to-yellow-600 hover:from-yellow-400 hover:to-yellow-500 transition-all h-full flex items-center justify-center gap-2 overflow-hidden"
    >
      <span class="relative z-10 text-black font-bold tracking-wider text-[11px] font-mono uppercase">Start</span>
      <iconify-icon icon="solar:arrow-right-linear" width="14" class="relative z-10 text-black group-hover:translate-x-1 transition-transform"></iconify-icon>
      <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/30 to-transparent -translate-x-full group-hover:translate-x-full transition-transform duration-700"></div>
    </a>
    
    <!-- Mobile Menu Button -->
    <button 
      class="lg:hidden flex items-center justify-center w-14 border-l border-white/5 text-zinc-400 hover:text-white hover:bg-white/5 transition-all"
      aria-label="Open menu"
      id="mobile-menu-button"
    >
      <iconify-icon icon="solar:hamburger-menu-linear" width="22"></iconify-icon>
    </button>
  </div>
</header>

<!-- Mobile Menu -->
<div id="mobile-menu" class="fixed inset-0 z-[60] bg-black/98 backdrop-blur-xl hidden flex-col">
  <!-- Mobile Header -->
  <div class="flex items-center justify-between p-4 border-b border-white/5">
    <a href="/" class="flex items-center gap-3">
      <div class="w-8 h-8 bg-gradient-to-br from-yellow-500 to-yellow-600 rounded-lg flex items-center justify-center">
        <span class="text-black font-bold text-sm">F</span>
      </div>
      <span class="text-white font-bold">{siteConfig.name}</span>
    </a>
    <button 
      class="w-10 h-10 flex items-center justify-center text-zinc-400 hover:text-white hover:bg-white/10 rounded-lg transition-colors"
      aria-label="Close menu"
      id="mobile-menu-close"
    >
      <iconify-icon icon="solar:close-circle-linear" width="24"></iconify-icon>
    </button>
  </div>
  
  <!-- Mobile Nav -->
  <nav class="flex-1 overflow-y-auto py-6 px-4" aria-label="Mobile navigation">
    <div class="space-y-2">
      {navigation.map((item) => {
        const colors = getColorClasses(item.accentColor || 'yellow');
        const href = getHref(item.href);
        const active = isActive(item.href);
        
        return (
          <a 
            href={href}
            class:list={[
              "mobile-nav-link flex items-center gap-4 p-4 rounded-xl border transition-all group",
              active 
                ? "bg-white/[0.05] border-white/10" 
                : "bg-white/[0.02] border-white/5 hover:bg-white/[0.05] hover:border-white/10"
            ]}
          >
            {item.icon && (
              <div class:list={["w-10 h-10 rounded-lg flex items-center justify-center border", colors.border, active ? "bg-white/10" : "bg-white/5"]}>
                <iconify-icon icon={item.icon} width="20" class:list={[colors.text]}></iconify-icon>
              </div>
            )}
            <div class="flex-1">
              <span class:list={["font-medium block", active ? "text-white" : "text-zinc-300"]}>{item.label}</span>
              <span class="text-[10px] text-zinc-600 font-mono uppercase">
                {item.href.includes('/staff') ? 'Engineering Talent' : 
                 item.href.includes('cards') ? 'Card Issuance' :
                 item.href.includes('infra') ? 'Development' :
                 item.href.includes('music') ? 'Distribution' :
                 item.href.includes('corp') ? 'Incorporation' : 'Service'}
              </span>
            </div>
            <iconify-icon 
              icon={active ? "solar:check-circle-linear" : "solar:arrow-right-linear"} 
              width="16" 
              class:list={["transition-all", active ? colors.text : "text-zinc-600 group-hover:text-white group-hover:translate-x-1"]}
            ></iconify-icon>
          </a>
        );
      })}
    </div>
  </nav>
  
  <!-- Mobile CTA -->
  <div class="p-4 border-t border-white/5">
    <a 
      href={currentPath === '/' ? '#contact-section' : '/#contact-section'}
      class="mobile-nav-link flex items-center justify-center gap-2 w-full py-4 bg-gradient-to-r from-yellow-500 to-yellow-600 rounded-xl text-black font-bold text-sm uppercase tracking-wider"
    >
      <span>Start Project</span>
      <iconify-icon icon="solar:arrow-right-linear" width="16"></iconify-icon>
    </a>
    
    <div class="flex items-center justify-center gap-4 mt-4 text-zinc-600">
      <a href={`mailto:${siteConfig.email}`} class="flex items-center gap-1.5 text-xs font-mono hover:text-white transition-colors">
        <iconify-icon icon="solar:letter-linear" width="14"></iconify-icon>
        Email
      </a>
      <span class="w-1 h-1 bg-zinc-700 rounded-full"></span>
      <a href={`https://wa.me/${siteConfig.whatsapp.replace(/\s/g, '')}`} class="flex items-center gap-1.5 text-xs font-mono hover:text-green-500 transition-colors">
        <iconify-icon icon="logos:whatsapp-icon" width="14"></iconify-icon>
        WhatsApp
      </a>
    </div>
  </div>
</div>

<script>
  // ===== Mobile Menu =====
  const menuButton = document.getElementById('mobile-menu-button');
  const menuClose = document.getElementById('mobile-menu-close');
  const mobileMenu = document.getElementById('mobile-menu');
  const mobileLinks = mobileMenu?.querySelectorAll('.mobile-nav-link');

  const openMenu = () => {
    mobileMenu?.classList.remove('hidden');
    mobileMenu?.classList.add('flex');
    document.body.style.overflow = 'hidden';
  };

  const closeMenu = () => {
    mobileMenu?.classList.add('hidden');
    mobileMenu?.classList.remove('flex');
    document.body.style.overflow = '';
  };

  menuButton?.addEventListener('click', openMenu);
  menuClose?.addEventListener('click', closeMenu);
  mobileLinks?.forEach(link => link.addEventListener('click', closeMenu));

  // ===== Active Section Tracking =====
  const navLinks = document.querySelectorAll('.nav-link[data-section]');
  const sections = new Map<string, Element>();
  
  // Collect sections
  navLinks.forEach(link => {
    const sectionId = link.getAttribute('data-section');
    if (sectionId) {
      const section = document.getElementById(sectionId);
      if (section) {
        sections.set(sectionId, section);
      }
    }
  });

  // Update active state based on scroll position
  const updateActiveSection = () => {
    const scrollPosition = window.scrollY + 100; // Offset for header
    let currentSection = '';

    sections.forEach((section, id) => {
      const rect = section.getBoundingClientRect();
      const sectionTop = rect.top + window.scrollY;
      const sectionBottom = sectionTop + rect.height;

      if (scrollPosition >= sectionTop && scrollPosition < sectionBottom) {
        currentSection = id;
      }
    });

    // Update nav links
    navLinks.forEach(link => {
      const sectionId = link.getAttribute('data-section');
      const indicator = link.querySelector('.nav-indicator');
      const isActive = sectionId === currentSection;

      if (isActive) {
        link.classList.remove('text-zinc-400');
        link.classList.add('text-white');
        indicator?.classList.remove('scale-x-0');
        indicator?.classList.add('scale-x-100');
      } else {
        link.classList.add('text-zinc-400');
        link.classList.remove('text-white');
        indicator?.classList.add('scale-x-0');
        indicator?.classList.remove('scale-x-100');
      }
    });
  };

  // Only track sections on pages that have them
  if (sections.size > 0) {
    window.addEventListener('scroll', updateActiveSection, { passive: true });
    updateActiveSection(); // Initial check
  }

  // ===== Smooth Scroll for Hash Links =====
  document.querySelectorAll('a[href*="#"]').forEach(anchor => {
    anchor.addEventListener('click', function(this: HTMLAnchorElement, e: Event) {
      const href = this.getAttribute('href');
      if (!href) return;

      const hashIndex = href.indexOf('#');
      if (hashIndex === -1) return;

      const hash = href.substring(hashIndex);
      const path = href.substring(0, hashIndex);
      
      // Check if we're on the same page
      const currentPath = window.location.pathname;
      const targetPath = path === '' ? currentPath : path;
      const isSamePage = targetPath === currentPath || targetPath === '/' && currentPath === '/';

      if (isSamePage) {
        const element = document.querySelector(hash);
        if (element) {
          e.preventDefault();
          closeMenu(); // Close mobile menu if open
          
          const headerOffset = 80;
          const elementPosition = element.getBoundingClientRect().top;
          const offsetPosition = elementPosition + window.pageYOffset - headerOffset;

          window.scrollTo({
            top: offsetPosition,
            behavior: 'smooth'
          });

          // Update URL without reload
          history.pushState(null, '', hash);
        }
      }
      // If not same page, let the browser handle the navigation
    });
  });
</script>
